<!DOCTYPE HTML>
<html>
<head>

<title>Video/Audio</title>

<link rel='stylesheet' type='text/css' href='../css/player.css' />
<link rel='stylesheet' type='text/css' href='../css/login.css' />
<style type="text/css">

</style>

<script src='../js/jquery.js'></script>

<script src='../js/cusVideo.js'></script>


<script type='text/javascript'>

var _videoId;
var vit;
var contents = [];
	
function getContent(sec){
	var result = contents[0];
	for (var i = 0; i < contents.length; i++) {
		curCon = contents[i];
		result = curCon;
		if (curCon.second<sec){
			continue;
		}
		if (curCon.second > sec){
			result = curCon;
			break;
		}
	};
	return result;
}

function setText(res){
	$("#preview").html(res.content);
}

function setPreview(){
	if (contents.length==0){
		return;
	}
	var res = getContent(vit.currentTime);
	switch (res.type){
		case "text":
			setText(res);
			break;
	}
}

function _setContentSecond(elm){
	console.log("The content with id: "+ elm.getAttribute("data-content") + " set new second: " + elm.value);
	console.log("TODO: update database with new second of content");
	$("tr[data-content='"+elm.getAttribute("data-content")+"']")[0].cells[1].innerHTML = elm.value;
}

function getUrlParameter(sParam) {
    var sPageURL = decodeURIComponent(window.location.search.substring(1)),
        sURLVariables = sPageURL.split('&'),
        sParameterName,
        i;

    for (i = 0; i < sURLVariables.length; i++) {
        sParameterName = sURLVariables[i].split('=');

        if (sParameterName[0] === sParam) {
            return sParameterName[1] === undefined ? true : sParameterName[1];
        }
    }
}
function sortfunction(a, b){
	if (a.second > b.second){
		return 1
	}
	return -1
}

function printData(){
	$("#contents").html("");
	contents.sort(sortfunction);
	var table = document.getElementById("posts");
	if (contents.length==0){
		return;
	}
	$("#contents").append(contents[0].content);	
	for (var i = 1; i < contents.length; i++) {
		$("#contents").append("<div class=lineSep></div>");
		$("#contents").append(contents[i].content);
	}
}

function setVideoSrc(videoId){
	$("#vitPlayer source").attr("src","http://52.23.174.169:3000/uploads/videos/video"+getUrlParameter("videoId")+".mp4");
	// $("#vitPlayer source").attr("src","../1.mp4");
}


var initCallback = function( data ) {
	contents = data.data;
	for (var i = 0; i < contents.length; i++) {
		contents[i].type="text";
	}
	printData();
	$('video').on("timeupdate", setPreview);
}

var updateCallback = function( data ) {
	for (var i = 0; i < contents.length; i++) {
		if (contents[i].id == data.text_id){
			for (var key in data){
				contents[i][key] = data[key];
			}
			break;
		}
	}
	printData();
}

function _getPosts(callback){
	var formData = {	
		'filters[video_id]' : _videoId,
		'debug' : true
	};

	var posting = $.get( "http://localhost:3000/text/get", formData );

	posting.done(callback);
}

$(document).ready(function() { 
	_videoId = getUrlParameter("videoId");
	vit = $('video')[0];
	$('video').videoPlayer({
		'playerWidth' : 0.95,
		'videoClass' : 'video',
	});

	setVideoSrc(_videoId);
	_getPosts(initCallback);


});

</script>

</head>
<body style="background-color:#f9f9f9;">

	<div id="wrapper"> 

		<div class="container" style="float:left; margin:20px;" >
			<video id="vitPlayer" style="object-fit: cover;height: 320px;">
				<source type="video/mp4">
			</video>

			<div id="preview" style="margin:20px;display:inline-block;position: absolute;">

			</div>

		</div>

		<div id="contents" style="margin:20px">
							<table id="posts" style="display:none;">
								<th>id</th>
								<th>seconds</th>
								<th>type</th>
								<th>content</th>
							</table>
		</div>
		<!-- 

		<div id="data-display" >
		    {{displayStack['comment'].length}}
		    <div ng-repeat="c in displayStack['comment']" >
		        {{c.text}}
		    </div>
		</div> -->
	</div>

</body>
</html>